---
title: Databases (update)
icon: Database
---

## –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã

### –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å master-slave —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –≤ mysql (–∫—Ä–∞—Ç–∫–æ)?

–ù–µ–æ–±—Ö–æ–¥–∏–º—ã 2 —Å–µ—Ä–≤–µ—Ä–∞: master –∏ slave.

1. –ù–∞ –æ–±–µ–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä MySQL –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏.
2. –í–∫–ª—é—á–∞–µ–º —Å–µ—Ä–≤–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –æ–±–µ–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö.
3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º master - –≤ `/etc/my.cnf` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª–µ—é—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è:

```
# –≤—ã–±–∏—Ä–∞–µ–º ID —Å–µ—Ä–≤–µ—Ä–∞, –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ, –ª—É—á—à–µ –Ω–∞—á–∏–Ω–∞—Ç—å —Å 1
server-id = 1
# –ø—É—Ç—å –∫ –±–∏–Ω–∞—Ä–Ω–æ–º—É –ª–æ–≥—É
log_bin = /var/log/mysql/mysql-bin.log
# –Ω–∞–∑–≤–∞–Ω–∏–µ –í–∞—à–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è
binlog_do_db = newdatabase
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. 4. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ master —Å–µ—Ä–≤–µ—Ä—É, —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞–∑–Ω–∞—á–∞–µ–º –µ–º—É –ø—Ä–∞–≤–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏.

```
mysql -u root -p <–ø–∞—Ä–æ–ª—å root —Å–µ—Ä–≤–µ—Ä–∞ –ë–î>
GRANT REPLICATION SLAVE ON *.* TO 'slave_user'@'%' IDENTIFIED BY 'password';
FLUSH PRIVILEGES;
```

5. –ù–∞ master —Å–µ—Ä–≤–µ—Ä–µ –¥–µ–ª–∞–µ–º –¥–∞–º–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö c –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π —Ç–∞–±–ª–∏—Ü.

```
mysqldump -u root -p --lock-all-tables newdatabase > newdatabase.sql
```

6. –ü–µ—Ä–µ–Ω–æ—Å–∏–º –¥–∞–º–ø –±–∞–∑—ã –Ω–∞ slave —Å–µ—Ä–≤–µ—Ä, —Å–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å —Ç–∞–∫–∏–º –∂–µ –∏–º–µ–Ω–µ–º –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∞–∑—É.

```
CREATE DATABASE newdatabase;
mysql -u root -p newdatabase < newdatabase.sql
```

7. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º slave –≤ `/etc/my.cnf`:

```
# ID –°–ª–µ–π–≤–∞, —É–¥–æ–±–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–º —á–∏—Å–ª–æ–º –ø–æ—Å–ª–µ –ú–∞—Å—Ç–µ—Ä–∞
server-id = 2
# –ü—É—Ç—å –∫ relay –ª–æ–≥—É
relay-log = /var/log/mysql/mysql-relay-bin.log
# –ü—É—Ç—å –∫ bin –ª–æ–≥—É –Ω–∞ –ú–∞—Å—Ç–µ—Ä–µ
log_bin = /var/log/mysql/mysql-bin.log
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
binlog_do_db = newdatabase
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. 8. –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –Ω–∞ slave —Å–µ—Ä–≤–µ—Ä–µ.

```
CHANGE MASTER TO MASTER_HOST='10.10.0.1', MASTER_USER='slave_user', MASTER_PASSWORD='password',
MASTER_LOG_FILE = 'mysql-bin.000001', MASTER_LOG_POS = 107;
##–£–∫–∞–∑–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –º—ã –±–µ—Ä–µ–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ú–∞—Å—Ç–µ—Ä–∞
–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –Ω–∞ –°–ª–µ–π–≤–µ:
START SLAVE;
```

9. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏:

```
SHOW SLAVE STATUSG
```

### –ö–∞–∫–æ–π —Ç–∏–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Prometheus?

Prometheus –∏—Å–ø–æ–ª—å–∑—É–µ—Ç TSDB (time series database).

### –ß—Ç–æ —Ç–∞–∫–æ–µ VACUUM –≤ PostgreSQL?

VACUUM –≤—ã—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –∑–∞–Ω–∏–º–∞–µ–º–æ–µ ¬´–º—ë—Ä—Ç–≤—ã–º–∏¬ª –∫–æ—Ä—Ç–µ–∂–∞–º–∏. –ü—Ä–∏ –æ–±—ã—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö PostgreSQL –∫–æ—Ä—Ç–µ–∂–∏, —É–¥–∞–ª—ë–Ω–Ω—ã–µ –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã; –æ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –Ω–µ–π, –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ VACUUM. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å VACUUM, –æ—Å–æ–±–µ–Ω–Ω–æ –¥–ª—è —á–∞—Å—Ç–æ –∏–∑–º–µ–Ω—è–µ–º—ã—Ö —Ç–∞–±–ª–∏—Ü.

–ë–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –∫–æ–º–∞–Ω–¥–∞ VACUUM –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –≤ —Ç–µ–∫—É—â–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç –æ—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å. –ï—Å–ª–∏ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–º—è —Ç–∞–±–ª–∏—Ü—ã, VACUUM –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É.

–ü—Ä–æ—Å—Ç–∞—è –∫–æ–º–∞–Ω–¥–∞ VACUUM (–±–µ–∑ FULL) —Ç–æ–ª—å–∫–æ –≤—ã—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏ –¥–µ–ª–∞–µ—Ç –µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –≠—Ç–∞ —Ñ–æ—Ä–º–∞ –∫–æ–º–∞–Ω–¥—ã –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –æ–±—ã—á–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ —Ç–∞–±–ª–∏—Ü—ã, —Ç–∞–∫ –æ–Ω–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏. –û–¥–Ω–∞–∫–æ –æ—Å–≤–æ–±–æ–∂–¥—ë–Ω–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ (–≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤); –æ–Ω–æ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞—ë—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ–π –∂–µ —Ç–∞–±–ª–∏—Ü—ã. VACUUM FULL –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ, –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –Ω–∏—á–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –≠—Ç–∞ —Ñ–æ—Ä–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è –∫–∞–∂–¥–æ–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–π —Ç–∞–±–ª–∏—Ü—ã.

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã

### –ú—ã –∑–Ω–∞–µ–º, —á—Ç–æ –µ—Å—Ç—å –≤—Å–µ–≥–æ 7 –∑–∞–ø–∏—Å–µ–π —Å `ticket_id=56412`. –ó–∞–ø–∏—Å–µ–π —Å `ticket_id > 60000` –Ω–µ—Ç, –Ω–∏–∫–∞–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –ø–µ—Ä–µ–¥ `56412` –Ω–µ—Ç. –ö–∞–∫ –º–æ–≥–ª–∞ –ø–æ—è–≤–∏—Ç—å—Å—è —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ? –û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è.

–ü–æ —É—Å–ª–æ–≤–∏—é –∑–∞–¥–∞—á–∏:

- `SELECT count(*) FROM tickets_messages WHERE ticket_id=56412;` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **5 –∑–∞–ø–∏—Å–µ–π**
- `SELECT count(*) FROM tickets_messages WHERE ticket_id LIKE '%56412';` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **7 –∑–∞–ø–∏—Å–µ–π**

–†–∞–∑–Ω–∏—Ü–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ –≤ –∫–æ–ª–æ–Ω–∫–µ `ticket_id` –º–æ–≥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –¥–∞–Ω–Ω—ã–µ **—Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤** (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç—Ä–æ–∫–∞ `VARCHAR` –≤–º–µ—Å—Ç–æ `INT`).

- –í —Å–ª—É—á–∞–µ —Å—Ç—Ä–æ–≥–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è `ticket_id=56412` –≤—ã–±–∏—Ä–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏, –≥–¥–µ –∑–Ω–∞—á–µ–Ω–∏–µ **—Å—Ç—Ä–æ–≥–æ —Ä–∞–≤–Ω–æ —á–∏—Å–ª—É 56412**.
- –í —Å–ª—É—á–∞–µ `LIKE '%56412'` –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –∑–∞–ø–∏—Å–∏, –≥–¥–µ –∑–Ω–∞—á–µ–Ω–∏–µ **–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ "56412"**, –≤–∫–ª—é—á–∞—è —Å—Ç—Ä–æ–∫–∏ –≤—Ä–æ–¥–µ:
  - `'56412'` (—Å—Ç—Ä–æ–∫–∞, —Å–æ–≤–ø–∞–¥–∞—é—â–∞—è —Å —á–∏—Å–ª–æ–º),
  - `'abc56412'`,
  - `'0056412'`.

üìå –ò—Ç–æ–≥: 2 ¬´–ª–∏—à–Ω–∏–µ¬ª –∑–∞–ø–∏—Å–∏ ‚Äî —ç—Ç–æ —Å—Ç—Ä–æ–∫–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö `ticket_id` —Å–æ–¥–µ—Ä–∂–∏—Ç `56412` –∫–∞–∫ –ø–æ–¥—Å—Ç—Ä–æ–∫—É, –Ω–æ –Ω–µ —Ä–∞–≤–µ–Ω —á–∏—Å–ª—É `56412`.

–ß—Ç–æ –±—ã —è —Å–¥–µ–ª–∞–ª:

1. –ü—Ä–æ–≤–µ—Ä–∏–ª —Ç–∏–ø –ø–æ–ª—è `ticket_id`:

```sql
\d tickets_messages    -- –≤ PostgreSQL
DESC tickets_messages; -- –≤ MySQL
```

2. –í—ã–≤–µ–ª –≤—Å–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```sql
SELECT ticket_id FROM tickets_messages WHERE ticket_id LIKE '%56412';
```

3. –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–ª –ø–æ–ª–µ (–ø—Ä–∏–≤—ë–ª –∫ —á–∏—Å–ª–æ–≤–æ–º—É —Ç–∏–ø—É, –µ—Å–ª–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ID).

### –ö–∞–∫–æ–π –∏–∑ –≤–æ–ø—Ä–æ—Å–æ–≤ MySQL —Å–∞–º—ã–π —Ç—è–∂–µ–ª—ã–π? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –∫–∞–∫ –≤—ã –µ–≥–æ –≤—ã—è–≤–∏–ª–∏?

import { Accordion, Accordions } from 'fumadocs-ui/components/accordion'

<Accordions type="single"> <Accordion title="–ó–∞–ø—Ä–æ—Å—ã">
```sql
# 1
#
# Time: 210707 15:39:36
# User@Host: 1703313381[1703313381] @  [136.243.53.188]  Id: 1138102510
# Schema: xxxxxx  Last_errno: 0  Killed: 0
# Query_time: 2.182754  Lock_time: 0.000120  Rows_sent: 0  Rows_examined: 324036  Rows_affected: 0
# Bytes_sent: 20494
SET timestamp=1625661576;
SELECT f.*, t.*, p.*, u.*, tt.mark_time AS topic_mark_time, ft.mark_time AS forum_mark_time FROM (phpbb_posts p CROSS JOIN phpbb_users u CROSS JOIN phpbb_topics t) LEFT JOIN phpbb_forums f ON (t.forum_id = f.forum_id) LEFT JOIN phpbb_topics_track tt ON (t.topic_id = tt.topic_id AND tt.user_id = 659822) LEFT JOIN phpbb_forums_track ft ON (f.forum_id = ft.forum_id AND ft.user_id = 659822) WHERE p.topic_id = t.topic_id
				AND p.poster_id = u.user_id
				 AND p.post_time > 1625660099
				 AND p.forum_id = 326
 
 
 
				AND p.post_approved = 1 ORDER BY t.topic_last_post_time DESC, p.post_time
 LIMIT 100;
 
# 2
#
# Time: 210707 15:38:11
# User@Host: 1703313381[1703313381] @  [136.243.53.188]  Id: 1138100591
# Schema: xxxxxx  Last_errno: 0  Killed: 0
# Query_time: 9.259469  Lock_time: 0.000015  Rows_sent: 0  Rows_examined: 948209  Rows_affected: 0
# Bytes_sent: 11
SET timestamp=1625661491;
DELETE FROM phpbb_post_revisions
			WHERE post_id = 10472158;
 
# 3
#
# Time: 210707 15:32:18
# User@Host: 1703313381[1703313381] @  [136.243.53.188]  Id: 1138094492
# Schema: xxxxxx  Last_errno: 0  Killed: 0
# Query_time: 1.113014  Lock_time: 0.000187  Rows_sent: 7  Rows_examined: 521597  Rows_affected: 0
# Bytes_sent: 178150
SET timestamp=1625661138;
SELECT f.*, t.*, p.*, u.*, tt.mark_time AS topic_mark_time, ft.mark_time AS forum_mark_time FROM (phpbb_posts p CROSS JOIN phpbb_users u CROSS JOIN phpbb_topics t) LEFT JOIN phpbb_forums f ON (t.forum_id = f.forum_id) LEFT JOIN phpbb_topics_track tt ON (t.topic_id = tt.topic_id AND tt.user_id = 427441) LEFT JOIN phpbb_forums_track ft ON (f.forum_id = ft.forum_id AND ft.user_id = 427441) WHERE p.topic_id = t.topic_id
				AND p.poster_id = u.user_id
				 AND p.post_time > 1625656199
				 AND p.forum_id IN (326, 527, 544, 1102)
 
 
 
				AND p.post_approved = 1 ORDER BY t.topic_last_post_time DESC, p.post_time
 LIMIT 18446744073709551615;
 
# 4
#
# Time: 210707 15:27:56
# User@Host: 1703313381[1703313381] @  [136.243.53.188]  Id: 1138089558
# Schema: xxxxxx  Last_errno: 0  Killed: 0
# Query_time: 4.682828  Lock_time: 0.000171  Rows_sent: 1  Rows_examined: 2457916  Rows_affected: 0
# Bytes_sent: 43233
SET timestamp=1625660876;
SELECT f.*, t.*, p.*, u.*, tt.mark_time AS topic_mark_time, ft.mark_time AS forum_mark_time FROM (phpbb_posts p CROSS JOIN phpbb_users u CROSS JOIN phpbb_topics t) LEFT JOIN phpbb_forums f ON (t.forum_id = f.forum_id) LEFT JOIN phpbb_topics_track tt ON (t.topic_id = tt.topic_id AND tt.user_id = 69079) LEFT JOIN phpbb_forums_track ft ON (f.forum_id = ft.forum_id AND ft.user_id = 69079) WHERE p.topic_id = t.topic_id
				AND p.poster_id = u.user_id
				 AND p.post_time > 1625660599
				 AND p.forum_id IN (9, 16, 17, 28, 36, 42, 55, 60, 65, 790, 64, 66, 110, 116, 837, 833, 133, 134, 135, 137, 143, 158, 823, 810, 788, 208, 211, 212, 213, 215, 216, 217, 218, 220, 221, 223, 224, 822, 836, 236, 238, 241, 242, 243, 270, 776, 291, 293, 294, 296, 292, 210, 40, 227, 239, 863, 781, 865, 548, 551, 552, 553, 554, 852, 851, 839, 550, 868, 884, 890, 909, 914, 916, 898, 896, 936, 937, 939, 969, 970, 982, 983, 989, 997, 92, 1076, 1124, 1130, 240, 1197, 1198, 1209, 1327, 1341, 1345, 1363, 1364, 1365, 1366, 1367, 1368, 1371, 1372, 1373, 1374, 1375, 1376, 1377, 1378, 1370, 1404, 1405, 1406, 1407, 1416, 1417, 1418, 1419, 1423, 1424, 1441, 1442, 1443, 1461, 1481, 1490, 1495, 1496, 1497, 1508, 1524, 1536, 1541, 1542, 119)
 
 
 
				AND p.post_approved = 1 ORDER BY t.topic_last_post_time DESC, p.post_time
 LIMIT 18446744073709551615;
```
</Accordion></Accordions>

#### –î–∞–Ω–Ω—ã–µ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º

1. **–ó–∞–ø—Ä–æ—Å #1**
   - `Query_time: 2.18s`
   - `Rows_examined: 324,036`
   - JOIN + —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ + LIMIT 100.
2. **–ó–∞–ø—Ä–æ—Å #2**
   - `Query_time: 9.25s`
   - `Rows_examined: 948,209`
   - `DELETE FROM phpbb_post_revisions WHERE post_id = ‚Ä¶;`
   - –û—á–µ–Ω—å –¥–æ–ª–≥–æ –¥–ª—è DELETE –ø–æ –æ–¥–Ω–æ–º—É `post_id`. –í–µ—Ä–æ—è—Ç–Ω–µ–µ –≤—Å–µ–≥–æ **–Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `post_id`**.
3. **–ó–∞–ø—Ä–æ—Å #3**
   - `Query_time: 1.11s`
   - `Rows_examined: 521,597`
   - JOIN + ORDER BY + LIMIT "–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π" (`18446744073709551615`). –¢–æ –µ—Å—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ **–±–µ–∑ LIMIT**, —á—Ç–æ –æ—á–µ–Ω—å —Ç—è–∂–µ–ª–æ.
4. **–ó–∞–ø—Ä–æ—Å #4**
   - `Query_time: 4.68s`
   - `Rows_examined: 2,457,916` (! –º–Ω–æ–≥–æ)
   - –¢–æ–∂–µ JOIN + ORDER BY + –æ–≥—Ä–æ–º–Ω—ã–π —Å–ø–∏—Å–æ–∫ `IN (‚Ä¶)` + "–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π" LIMIT.

#### –°–∞–º—ã–π —Ç—è–∂—ë–ª—ã–π

üëâ **–ó–∞–ø—Ä–æ—Å #2 (DELETE)**

- 9.25s (—Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
- –ø–æ—á—Ç–∏ –º–∏–ª–ª–∏–æ–Ω —Å—Ç—Ä–æ–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏.
  –≠—Ç–æ —è–≤–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–Ω–¥–µ–∫—Å–∞ –ø–æ `post_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `phpbb_post_revisions`.

#### –ö–∞–∫ –≤—ã—è–≤–∏–ª–∏

1. –í–∑—è–ª slow-log.
2. –°—Ä–∞–≤–Ω–∏–ª `Query_time` –∏ `Rows_examined`.
3. –ó–∞–ø—Ä–æ—Å #2 –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ —Å–∞–º—ã–π —Ç—è–∂—ë–ª—ã–π (–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –∏ –ø–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏).

#### –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã:
  `SHOW CREATE TABLE phpbb_post_revisions\G`
- –ï—Å–ª–∏ –ø–æ `post_id` –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ ‚Üí –¥–æ–±–∞–≤–∏—Ç—å:
  `CREATE INDEX idx_post_id ON phpbb_post_revisions(post_id);`
- –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏—Ç—å EXPLAIN:
  `EXPLAIN DELETE FROM phpbb_post_revisions WHERE post_id = 10472158;`
